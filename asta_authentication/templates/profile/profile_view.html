{% extends 'layout.html' %}
{% block title %}{{ user.name }}'s Profile{% endblock %}

{% block content %}
<form id="imageUploadForm" action="{{ url_for('profile.upload_images') }}" method="POST" enctype="multipart/form-data" class="d-none">
    <input type="file" id="bannerUpload" name="banner_image" onchange="this.form.submit()">
    <input type="file" id="profilePicUpload" name="profile_picture" onchange="this.form.submit()">
</form>

<!-- Profile Header -->
<div class="card profile-header-card">
    <div class="profile-banner-container">
        <img src="{{ user.banner_url or url_for('static', filename='images/bg.png') }}" alt="Banner Image" class="profile-banner">
        {% if current_user.id == user.id %}
        <a class="edit-icon-overlay" style="top: 15px; right: 15px;" onclick="document.getElementById('bannerUpload').click();" title="Edit banner">
            <i class="fas fa-camera"></i>
        </a>
        {% endif %}
        <img src="{{ user.profile_pic_url or url_for('static', filename='images/dp.jpeg') }}" alt="Profile Picture" class="profile-picture">
        
        {% if current_user.id == user.id %}
        <a class="edit-icon-overlay" style="top: auto; bottom: 15px; right: 15px;" onclick="document.getElementById('profilePicUpload').click();" title="Edit profile picture">
            <i class="fas fa-camera"></i>
        </a>
        {% endif %}
    </div>
    
    <div class="profile-header-content p-4">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="mb-0 fw-bold">{{ user.name }}</h2>
                <p class="text-muted fs-5">{{ user.headline or 'Update your headline' }}</p>
                {% if user.location %}
                <p class="text-muted mb-2">
                    <i class="fas fa-map-marker-alt me-1"></i>{{ user.location }}
                </p>
                {% endif %}
                
                <!-- Career GPS Banner -->
                {% if user.career_gps and user.career_gps.selected_career %}
                <div class="alert alert-success d-inline-flex align-items-center mt-2 py-2 px-3 rounded-pill">
                    <i class="fas fa-compass me-2"></i>
                    <span>Guided by Career GPS → {{ user.career_gps.selected_career }} | {{ user.career_gps.progress }}% Complete</span>
                    <a href="#" class="ms-2" data-bs-toggle="tooltip" title="✨ Update or Explore New Directions">
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </div>
                {% else %}
                <a href="{{ url_for('profile.start_career_gps') }}" class="btn btn-outline-primary btn-sm mt-2">
                    <i class="fas fa-compass me-1"></i> Discover My Career Path
                </a>
                {% endif %}
            </div>
            
            <div class="text-end">
                {% if user.university %}
                <h5 class="fw-bold">
                    <i class="fas fa-university me-2"></i>{{ user.university }}
                </h5>
                {% endif %}
                
                {% if current_user.id != user.id %}
                <div class="mt-3">
                    {% if not is_connected %}
                        <button onclick="sendConnectionRequest('{{ user.id }}')" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i> Connect
                        </button>
                    {% else %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i> Connected
                        </span>
                    {% endif %}
                </div>
                {% endif %}
                {% if current_user.id == user.id %}
                <div class="mt-3">
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editBasicModal">
                        <i class="far fa-id-card me-1"></i> Edit Profile
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Career GPS Roadmap Section -->
{% if user.career_gps and user.career_gps.selected_career %}
<div class="card mt-4" id="careerGpsSection">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-bold mb-0">Career GPS Journey</h5>
        <a href="{{ url_for('profile.start_career_gps') }}" class="btn btn-sm btn-outline-secondary" title="Update My GPS">
            <i class="fas fa-sync-alt me-1"></i> Update
        </a>
    </div>
    <div class="card-body">
        <h6 class="fw-bold text-primary">{{ user.career_gps.selected_career }}</h6>

        <!-- Progress Bar -->
        <div class="mb-4">
            <div class="d-flex justify-content-between mb-1">
                <small class="fw-500">Progress</small>
                <small class="fw-bold">{{ user.career_gps.progress }}% Complete</small>
            </div>
            <div class="progress" style="height: 8px">
                <div class="progress-bar bg-success" 
                     role="progressbar" 
                     style="width: {{ user.career_gps.progress }}%"
                     aria-valuenow="{{ user.career_gps.progress }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
            </div>
        </div>

        <!-- Milestone Timeline -->
        <h6 class="mt-4 mb-3 fw-bold">Your Journey</h6>
        <div class="timeline-steps">
            {% set milestones = [
                {'name': 'Career Discovery', 'icon': 'compass', 'threshold': 0},
                {'name': 'Skill Assessment', 'icon': 'clipboard-check', 'threshold': 25},
                {'name': 'Learning Path', 'icon': 'route', 'threshold': 50},
                {'name': 'Mentorship', 'icon': 'user-graduate', 'threshold': 75},
                {'name': 'Career Ready', 'icon': 'trophy', 'threshold': 100}
            ] %}
            
            {% for milestone in milestones %}
            <div class="step {% if user.career_gps.progress >= milestone.threshold %}completed{% endif %}">
                <div class="step-icon">
                    <i class="fas fa-{{ milestone.icon }}"></i>
                </div>
                <div class="step-content">
                    <h6 class="mb-0">{{ milestone.name }}</h6>
                    {% if user.career_gps.progress >= milestone.threshold %}
                        <small class="text-success"><i class="fas fa-check-circle"></i> Completed</small>
                    {% else %}
                        <small class="text-muted">
                            {{ 'In Progress' if milestone.threshold == 25 else 'Upcoming' }}
                        </small>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Mentor Recommendations -->
        <h6 class="mt-5 mb-3 fw-bold">Recommended Mentors</h6>
        <div class="row g-3">
            {% set mentors = [
                {'name': 'Industry Expert', 'role': 'Senior ' + user.career_gps.selected_career, 'icon': 'user-tie'},
                {'name': 'Career Coach', 'role': 'Professional Development', 'icon': 'chalkboard-teacher'},
                {'name': 'Alumni Network', 'role': 'Peer Mentor', 'icon': 'users'}
            ] %}
            
            {% for mentor in mentors %}
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center p-4">
                        <div class="avatar-lg mx-auto mb-3">
                            <div class="avatar-title bg-soft-primary text-primary rounded-circle">
                                <i class="fas fa-{{ mentor.icon }} fs-4"></i>
                            </div>
                        </div>
                        <h5 class="mb-1">{{ mentor.name }}</h5>
                        <p class="text-muted mb-3">{{ mentor.role }}</p>
                        <button class="btn btn-outline-primary btn-sm w-100">
                            <i class="far fa-envelope me-1"></i> Contact
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- About Section -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-bold mb-0">About</h5>
        {% if current_user.id == user.id %}
        <a href="#" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editAboutModal">
            <i class="fas fa-pencil-alt me-1"></i> Edit
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="mb-4">
            <p class="mb-0">{{ user.about or 'No information provided yet.' }}</p>
        </div>
        
        {% if user.career_gps and user.career_gps.selected_career %}
        <div class="alert alert-light border">
            <div class="d-flex">
                <div class="flex-shrink-0 text-primary">
                    <i class="fas fa-graduation-cap fa-2x"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">Personalized Learning Plan</h6>
                    <p class="mb-2 text-muted">
                        Based on your career path in {{ user.career_gps.selected_career }}, we've created a custom learning plan to help you develop the necessary skills.
                    </p>
                    <a href="{{ url_for('profile.my_learning_paths') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt me-1"></i> View Learning Paths
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Experience Section -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-bold mb-0">Experience</h5>
        {% if current_user.id == user.id %}
        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addExperienceModal">
            <i class="fas fa-plus me-1"></i> Add
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if user.experience %}
            {% for exp in user.experience %}
            <div class="d-flex align-items-start py-3 {% if not loop.last %}border-bottom{% endif %}">
                <div class="flex-shrink-0 me-3">
                    {% if exp.logo %}
                        <img src="{{ exp.logo }}" alt="{{ exp.company }} logo" class="rounded" style="width: 50px; height: 50px; object-fit: contain;">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-briefcase text-secondary"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-1">{{ exp.title }}</h6>
                    <p class="mb-1 text-muted">{{ exp.company }}</p>
                    <small class="text-muted d-block">
                        <i class="far fa-calendar-alt me-1"></i>{{ exp.dates }}
                        {% if exp.location %}
                            <span class="mx-2">·</span>
                            <i class="fas fa-map-marker-alt me-1"></i>{{ exp.location }}
                        {% endif %}
                    </small>
                    {% if exp.description %}
                    <p class="mt-2 mb-0 text-muted">{{ exp.description }}</p>
                    {% endif %}
                </div>
                {% if current_user.id == user.id %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editExperienceModal-{{ exp.id }}">
                                <i class="far fa-edit me-2"></i>Edit
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="far fa-trash-alt me-2"></i>Delete
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-briefcase fa-3x text-muted"></i>
                </div>
                <h6 class="fw-bold">No experience added yet</h6>
                <p class="text-muted mb-0">Share your work experience to showcase your professional journey</p>
                {% if current_user.id == user.id %}
                <a href="#" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addExperienceModal">
                    <i class="fas fa-plus me-1"></i> Add Experience
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Education Section -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-bold mb-0">Education</h5>
        {% if current_user.id == user.id %}
        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addEducationModal">
            <i class="fas fa-plus me-1"></i> Add
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if user.education %}
            {% for edu in user.education %}
            <div class="d-flex align-items-start py-3 {% if not loop.last %}border-bottom{% endif %}">
                <div class="flex-shrink-0 me-3">
                    {% if edu.school_logo %}
                        <img src="{{ edu.school_logo }}" alt="{{ edu.school }} logo" class="rounded" style="width: 50px; height: 50px; object-fit: contain;">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-university text-secondary"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-1">{{ edu.degree }}, {{ edu.field_of_study }}</h6>
                    <p class="mb-1 text-muted">{{ edu.school }}</p>
                    <small class="text-muted d-block">
                        <i class="far fa-calendar-alt me-1"></i>{{ edu.dates }}
                        {% if edu.grade %}
                            <span class="mx-2">·</span>
                            <i class="fas fa-star me-1"></i>{{ edu.grade }}
                        {% endif %}
                    </small>
                    {% if edu.activities %}
                    <p class="mt-2 mb-0 text-muted">{{ edu.activities }}</p>
                    {% endif %}
                </div>
                {% if current_user.id == user.id %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editEducationModal-{{ loop.index }}">
                                <i class="far fa-edit me-2"></i>Edit
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="far fa-trash-alt me-2"></i>Delete
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-graduation-cap fa-3x text-muted"></i>
                </div>
                <h6 class="fw-bold">No education added yet</h6>
                <p class="text-muted mb-0">Add your education to showcase your academic background</p>
                {% if current_user.id == user.id %}
                <a href="#" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addEducationModal">
                    <i class="fas fa-plus me-1"></i> Add Education
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Skills Section -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-bold mb-0">Skills</h5>
        {% if current_user.id == user.id %}
        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addSkillModal">
            <i class="fas fa-plus me-1"></i> Add
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if user.skills %}
            <div class="d-flex flex-wrap gap-2 mb-3">
                {% for skill in user.skills %}
                <span class="badge bg-light text-dark border p-2 d-flex align-items-center">
                    {% if skill.icon %}
                        <i class="{{ skill.icon }} me-1"></i>
                    {% endif %}
                    {{ skill.name }}
                    {% if skill.level %}
                        <span class="ms-2 text-muted">{{ skill.level }}/10</span>
                    {% endif %}
                    {% if current_user.id == user.id %}
                    <a href="#" class="ms-2 text-muted" data-bs-toggle="modal" data-bs-target="#editSkillModal-{{ loop.index }}">
                        <i class="far fa-edit"></i>
                    </a>
                    {% endif %}
                </span>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-tools fa-3x text-muted"></i>
                </div>
                <h6 class="fw-bold">No skills added yet</h6>
                <p class="text-muted mb-0">Add your skills to showcase your expertise</p>
                {% if current_user.id == user.id %}
                <a href="#" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addSkillModal">
                    <i class="fas fa-plus me-1"></i> Add Skills
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Certifications Section -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title fw-bold mb-0">Licenses & Certifications</h5>
        {% if current_user.id == user.id %}
        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCertificationModal">
            <i class="fas fa-plus me-1"></i> Add
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if user.certifications %}
            {% for cert in user.certifications %}
            <div class="d-flex align-items-start py-3 {% if not loop.last %}border-bottom{% endif %}">
                <div class="flex-shrink-0 me-3">
                    {% if cert.issuer_logo %}
                        <img src="{{ cert.issuer_logo }}" alt="{{ cert.issuer }} logo" class="rounded" style="width: 50px; height: 50px; object-fit: contain;">
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-certificate text-secondary"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-1">{{ cert.name }}</h6>
                    <p class="mb-1 text-muted">{{ cert.issuer }}</p>
                    <small class="text-muted d-block">
                        <i class="far fa-calendar-alt me-1"></i>
                        {{ cert.issue_date }}
                        {% if cert.expiration_date %}
                            - {{ cert.expiration_date }}
                        {% endif %}
                        {% if cert.credential_id %}
                            <span class="mx-2">·</span>
                            <span>Credential ID: {{ cert.credential_id }}</span>
                        {% endif %}
                    </small>
                    {% if cert.credential_url %}
                    <a href="{{ cert.credential_url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                        <i class="fas fa-external-link-alt me-1"></i> Show Credential
                    </a>
                    {% endif %}
                </div>
                {% if current_user.id == user.id %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editCertificationModal-{{ loop.index }}">
                                <i class="far fa-edit me-2"></i>Edit
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="far fa-trash-alt me-2"></i>Delete
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-award fa-3x text-muted"></i>
                </div>
                <h6 class="fw-bold">No certifications added yet</h6>
                <p class="text-muted mb-0">Add your certifications to showcase your qualifications</p>
                {% if current_user.id == user.id %}
                <a href="#" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addCertificationModal">
                    <i class="fas fa-plus me-1"></i> Add Certification
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Posts Section -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title fw-bold mb-0">Posts</h5>
    </div>
    <div class="card-body">
        {% if posts %}
            {% for post in posts %}
                {% include 'posts/_post_card.html' %}
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <i class="far fa-newspaper fa-3x text-muted mb-3"></i>
                <h6 class="fw-bold">No posts yet</h6>
                <p class="text-muted">When you share something, it will appear here</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Include all modals -->
{% if current_user.id == user.id %}
    <!-- Edit Basic Profile Modal -->
    <div class="modal fade" id="editBasicModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editBasicForm">
                        <div class="mb-3">
                            <label for="basicName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="basicName" name="name" value="{{ user.name or '' }}" placeholder="Your name">
                        </div>
                        <div class="mb-3">
                            <label for="basicHeadline" class="form-label">Headline</label>
                            <input type="text" class="form-control" id="basicHeadline" name="headline" value="{{ user.headline or '' }}" placeholder="e.g., Full Stack Developer">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveBasicBtn">Save</button>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.getElementById('saveBasicBtn')?.addEventListener('click', function () {
        const form = document.getElementById('editBasicForm');
        const fd = new URLSearchParams(new FormData(form));
        fetch('/profile/edit-basic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: fd.toString(),
            credentials: 'same-origin'
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                location.reload();
            } else {
                alert(d.error || 'Failed to update profile');
            }
        })
        .catch(() => alert('Failed to update profile'));
    });
    </script>
    {% include 'profile/modals/edit_about_modal.html' %}
    {% include 'profile/modals/add_experience_modal.html' %}
    {% include 'profile/modals/add_education_modal.html' %}
    {% include 'profile/modals/add_skill_modal.html' %}
    {% include 'profile/modals/add_certification_modal.html' %}
    
    <!-- Edit modals for each item -->
    {% if user.experience %}
        {% for exp in user.experience %}
            {% with experience=exp %}
                {% include 'profile/modals/edit_experience_modal.html' %}
            {% endwith %}
        {% endfor %}
    {% endif %}
    
    {% if user.education %}
        {% for edu in user.education %}
            {% with education=edu %}
                {% include 'profile/modals/edit_education.html' %}
            {% endwith %}
        {% endfor %}
    {% endif %}
    
    {% if user.skills %}
        {% for skill in user.skills %}
            {% with skill=skill, index=loop.index %}
                {% include 'profile/modals/edit_skill_modal.html' %}
            {% endwith %}
        {% endfor %}
    {% endif %}
    
    {% if user.certifications %}
        {% for cert in user.certifications %}
            {% with certification=cert, index=loop.index %}
                {% include 'profile/modals/edit_certification_modal.html' %}
            {% endwith %}
        {% endfor %}
    {% endif %}
{% endif %}

<!-- Connection Request Modal -->
<div class="modal fade" id="connectionRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Connection Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Send a connection request to {{ user.name }} to connect on our platform.</p>
                <div class="mb-3">
                    <label for="message" class="form-label">Add a note (optional)</label>
                    <textarea class="form-control" id="connectionMessage" rows="3" placeholder="Hi {{ user.first_name }}, I'd like to add you to my professional network."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSendRequest">Send Request</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Handle connection request
function sendConnectionRequest(userId) {
    // Show loading state
    const connectBtn = document.querySelector('button[onclick^="sendConnectionRequest"]');
    const originalContent = connectBtn ? connectBtn.innerHTML : '';
    
    if (connectBtn) {
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    }
    
    fetch(`/profile/api/user/${userId}/connect`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Failed to send request');
            }).catch(() => {
                throw new Error('Failed to process response');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Connection request sent!', 'success');
            // Update UI based on connection status
            if (connectBtn) {
                if (data.status === 'connected') {
                    connectBtn.outerHTML = `
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i> Connected
                        </span>
                    `;
                } else {
                    connectBtn.outerHTML = `
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-clock me-1"></i> Request Sent
                        </span>
                    `;
                }
            }
            
            // Optional: Reload the page after a short delay to reflect changes
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.error || 'Failed to send connection request', 'error');
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.innerHTML = originalContent;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(error.message || 'An error occurred while processing your request', 'error');
        if (connectBtn) {
            connectBtn.disabled = false;
            connectBtn.innerHTML = originalContent;
        }
    });
}
// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});
</script>

<style>
/* Profile header styles */
.profile-header-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    overflow: hidden;
}

.profile-banner-container {
    position: relative;
    height: 200px;
    background-color: #f0f2f5;
    overflow: hidden;
}

.profile-banner {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-picture {
    position: absolute;
    left: 30px;
    bottom: -50px;
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 4px solid #fff;
    background-color: #fff;
    object-fit: cover;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.profile-header-content {
    margin-top: 60px;
    padding: 0 30px 30px 30px;
}

.edit-icon-overlay {
    position: absolute;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
}

.edit-icon-overlay:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.05);
}

/* Timeline steps */
.timeline-steps {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
    position: relative;
}

.timeline-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 3px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    right: -50%;
    height: 3px;
    background: #e9ecef;
    z-index: 1;
}

.step.completed:not(:last-child)::after {
    background: #0d6efd;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    color: #6c757d;
    font-weight: 600;
    position: relative;
    z-index: 2;
}

.step.completed .step-icon {
    background: #0d6efd;
    color: white;
}

.step-content {
    text-align: center;
    margin-top: 0.5rem;
}

/* Avatar styles */
.avatar-lg {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin: 0 auto;
}

.avatar-title {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .profile-picture {
        width: 120px;
        height: 120px;
        left: 50%;
        transform: translateX(-50%);
        bottom: -40px;
    }
    
    .profile-header-content {
        margin-top: 80px;
        text-align: center;
    }
    
    .profile-header-content .btn {
        margin: 0.5rem 0;
    }
    
    .timeline-steps {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .step {
        flex-direction: row;
        margin-bottom: 1.5rem;
        width: 100%;
    }
    
    .step:not(:last-child)::after {
        top: 20px;
        left: 20px;
        right: auto;
        width: 3px;
        height: 100%;
    }
    
    .step-icon {
        margin-right: 1rem;
        margin-bottom: 0;
    }
    
    .step-content {
        text-align: left;
        margin-top: 0;
    }
}
</style>

<!-- duplicate profile sections removed -->

{% include 'profile/modals/edit_about.html' %}

{# Add Modals #}
{% include 'profile/modals/add_education.html' %}
{% include 'profile/modals/add_experience.html' %}
{% include 'profile/modals/add_skill.html' %}
{% include 'profile/modals/add_certification.html' %}

<!-- Edit Modals -->
{% for edu in user.education %}
    {% include 'profile/modals/edit_education.html' %}
{% endfor %}
{% for exp in user.experience %}
    {% include 'profile/modals/edit_experience.html' %}
{% endfor %}
{% for skill in user.skills %}
    {% with index=loop.index %}
    {% include 'profile/modals/edit_skill.html' %}
    {% endwith %}
{% endfor %}
{% if user.certifications %}
{% for cert in user.certifications %}
    {% include 'profile/modals/edit_certification.html' %}
{% endfor %}
{% endif %}

{% endblock %}
